{% extends "layouts/page.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}

{% block pageTitle %}{{ pageTitle }} - Defra AI Code Review{% endblock %}

{% block content %}
<div class="govuk-width-container">
  <main class="govuk-main-wrapper" id="main-content" role="main">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <a href="/projects" class="govuk-back-link">Back to projects</a>

        {% if error %}
          {{ govukErrorSummary({
            titleText: "There is a problem",
            errorList: [
              {
                text: error,
                href: "#"
              }
            ]
          }) }}
        {% endif %}

        {% if project %}
          <h1 class="govuk-heading-xl">{{ project.name }}</h1>

          <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">Governance Template</dt>
              <dd class="govuk-summary-list__value">
                {{ project.governanceTemplate.name }} (v{{ project.governanceTemplate.version }})
              </dd>
            </div>
            {% if project.description %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">Description</dt>
                <dd class="govuk-summary-list__value">{{ project.description }}</dd>
              </div>
            {% endif %}
          </dl>

          {% if project.workflowInstances and project.workflowInstances.length > 0 %}
            {% for workflow in project.workflowInstances %}
              <div class="govuk-!-margin-bottom-9">
                <h2 class="govuk-heading-l">{{ workflow.name }}</h2>
                
                {% if workflow.description %}
                  <p class="govuk-body">{{ workflow.description }}</p>
                {% endif %}

                {% if workflow.checklistItems and workflow.checklistItems.length > 0 %}
                  {% set tableRows = [] %}
                  {% for item in workflow.checklistItems %}
                    {% set statusHtml %}
                      <form method="POST" action="/checklist-item-instances/{{ item._id }}/status" class="govuk-!-margin-bottom-0">
                        {{ govukRadios({
                          classes: "govuk-radios--small govuk-radios--inline",
                          name: "status",
                          value: item.status,
                          items: [
                            {
                              value: "incomplete",
                              text: "Incomplete",
                              checked: item.status == "incomplete"
                            },
                            {
                              value: "complete",
                              text: "Complete",
                              checked: item.status == "complete"
                            },
                            {
                              value: "not_required",
                              text: "Not Required",
                              checked: item.status == "not_required"
                            }
                          ],
                          attributes: {
                            "data-testid": "status-radio-" + item._id,
                            "onchange": "this.form.submit()"
                          }
                        }) }}
                      </form>
                    {% endset %}

                    {% set row = [
                      {
                        text: item.name,
                        classes: "govuk-!-font-weight-bold"
                      },
                      {
                        text: item.type | title if item.type else "Not specified"
                      },
                      {
                        text: item.description if item.description else "No description provided"
                      },
                      {
                        html: statusHtml
                      }
                    ] %}
                    {% set tableRows = (tableRows.push(row), tableRows) %}
                  {% endfor %}

                  {{ govukTable({
                    firstCellIsHeader: true,
                    head: [
                      { text: "Name" },
                      { text: "Type" },
                      { text: "Description" },
                      { text: "Status" }
                    ],
                    rows: tableRows
                  }) }}
                {% else %}
                  <p class="govuk-body">No checklist items found for this workflow.</p>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p class="govuk-body">No workflow instances found for this project.</p>
          {% endif %}

          <script>
            // Handle status updates via AJAX
            document.addEventListener('submit', function(e) {
              if (e.target.action.includes('/checklist-item-instances/')) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                
                fetch(form.action, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(Object.fromEntries(formData))
                })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  // Optionally show success message
                })
                .catch(error => {
                  console.error('Error:', error);
                  // Show error message to user
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'govuk-error-summary';
                  errorDiv.innerHTML = `
                    <div role="alert">
                      <h2 class="govuk-error-summary__title">There is a problem</h2>
                      <div class="govuk-error-summary__body">
                        <p>Unable to update status. Please try again.</p>
                      </div>
                    </div>
                  `;
                  form.parentNode.insertBefore(errorDiv, form);
                });
              }
            });
          </script>
        {% endif %}
      </div>
    </div>
  </main>
</div>
{% endblock %} 